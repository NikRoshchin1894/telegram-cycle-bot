import OpenAI from 'openai';

export class ChatGptService {
  constructor() {
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });
  }

  async generateRecommendations(cycleDay, phase) {
    try {
      const prompt = this.buildPrompt(cycleDay, phase);
      
      const response = await this.openai.chat.completions.create({
        model: "gpt-4o",
        messages: [
          {
            role: "system",
            content: "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∂–µ–Ω—Å–∫–æ–º—É –∑–¥–æ—Ä–æ–≤—å—é –∏ –ø–∏—Ç–∞–Ω–∏—é. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∂–µ–Ω—â–∏–Ω–∞–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–Ω—è –∏—Ö –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        max_tokens: 800,
        temperature: 0.7,
      });

      return response.choices[0].message.content;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:', error);
      return this.getFallbackRecommendations(cycleDay, phase);
    }
  }

  buildPrompt(cycleDay, phase) {
    return `
–°–µ–≥–æ–¥–Ω—è ${cycleDay} –¥–µ–Ω—å –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞, —Ñ–∞–∑–∞: ${phase.name} - ${phase.description}.

–°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∂–µ–Ω—â–∏–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –Ω–∞ 3 –±–ª–æ–∫–∞:

üß† –£–ú–°–¢–í–ï–ù–ù–ê–Ø –ù–ê–ì–†–£–ó–ö–ê:
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–±–æ—Ç–µ, —É—á–µ–±–µ, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏
- –°–æ–≤–µ—Ç—ã –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å—Ç—Ä–µ—Å—Å–æ–º
- –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

üèÉ‚Äç‚ôÄÔ∏è –°–ü–û–†–¢ –ò –ê–ö–¢–ò–í–ù–û–°–¢–¨:
- –ü–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∏–¥—ã —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è

ü•ó –ü–ò–¢–ê–ù–ò–ï:
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
- –ß—Ç–æ –ª—É—á—à–µ –∏—Å–∫–ª—é—á–∏—Ç—å
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∏—Ç–∞–Ω–∏—è –≤ —ç—Ç—É —Ñ–∞–∑—É

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º—ã–º. –ö–∞–∂–¥—ã–π –±–ª–æ–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ë—É–¥—å –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π, —É—á–∏—Ç—ã–≤–∞–π –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –≤ —ç—Ç—É —Ñ–∞–∑—É —Ü–∏–∫–ª–∞.
`;
  }

  getFallbackRecommendations(cycleDay, phase) {
    // –†–µ–∑–µ—Ä–≤–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ ChatGPT
    const fallbackRecommendations = {
      menstruation: {
        mental: "–°–µ–≥–æ–¥–Ω—è –ª—É—á—à–µ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ –ª–µ–≥–∫–∏—Ö –∑–∞–¥–∞—á–∞—Ö, –∏–∑–±–µ–≥–∞—Ç—å –ø—Ä–∏–Ω—è—Ç–∏—è –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –û—Ç–¥—ã—Ö –∏ –º–µ–¥–∏—Ç–∞—Ü–∏—è –ø–æ–º–æ–≥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏–ª—ã.",
        sport: "–õ–µ–≥–∫–∏–µ –ø—Ä–æ–≥—É–ª–∫–∏, –π–æ–≥–∞, —Ä–∞—Å—Ç—è–∂–∫–∞. –ò–∑–±–µ–≥–∞–π—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ - –¥–∞–π—Ç–µ —Ç–µ–ª—É –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.",
        nutrition: "–£–ø–æ—Ç—Ä–µ–±–ª—è–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã –±–æ–≥–∞—Ç—ã–µ –∂–µ–ª–µ–∑–æ–º (–º—è—Å–æ, —à–ø–∏–Ω–∞—Ç), –ø–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã. –ò—Å–∫–ª—é—á–∏—Ç–µ –∫–æ—Ñ–µ–∏–Ω –∏ –∞–ª–∫–æ–≥–æ–ª—å."
      },
      follicular: {
        mental: "–û—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∏–∑—É—á–µ–Ω–∏—è. –≠–Ω–µ—Ä–≥–∏—è —Ä–∞—Å—Ç–µ—Ç, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —É–ª—É—á—à–∞–µ—Ç—Å—è. –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–µ–ª–∞.",
        sport: "–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫. –ö–∞—Ä–¥–∏–æ, —Å–∏–ª–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç–∞–Ω—Ü—ã - –≤—Å–µ –ø–æ–¥–æ–π–¥–µ—Ç.",
        nutrition: "–°–≤–µ–∂–∏–µ –æ–≤–æ—â–∏ –∏ —Ñ—Ä—É–∫—Ç—ã, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å –±–µ–ª–∫–∞ –¥–ª—è —Ä–æ—Å—Ç–∞ —ç–Ω–µ—Ä–≥–∏–∏."
      },
      ovulation: {
        mental: "–ü–∏–∫ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π! –í—Ä–µ–º—è –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á, –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤, —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.",
        sport: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å - –ø—Ä–æ–±–µ–∂–∫–∏, HIIT, –∫–æ–º–∞–Ω–¥–Ω—ã–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã—Å–æ–∫—É—é —ç–Ω–µ—Ä–≥–∏—é.",
        nutrition: "–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –±–µ–ª–∫–∏ –∏ —É–≥–ª–µ–≤–æ–¥—ã. –ü–µ–π—Ç–µ –º–Ω–æ–≥–æ –≤–æ–¥—ã."
      },
      luteal: {
        mental: "–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –Ω–∞—á–∞—Ç—ã—Ö –¥–µ–ª. –ò–∑–±–µ–≥–∞–π—Ç–µ —Å—Ç—Ä–µ—Å—Å–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π, –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ —Ä–µ–ª–∞–∫—Å–∞—Ü–∏—é.",
        sport: "–£–º–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏ - –ø–ª–∞–≤–∞–Ω–∏–µ, –π–æ–≥–∞, –ø–∏–ª–∞—Ç–µ—Å. –°–ª—É—à–∞–π—Ç–µ —Å–≤–æ–µ —Ç–µ–ª–æ.",
        nutrition: "–°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, –º–∞–≥–Ω–∏–π (–æ—Ä–µ—Ö–∏, —Ç–µ–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥). –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ —Å–∞—Ö–∞—Ä."
      }
    };

    const recommendations = fallbackRecommendations[phase.key] || fallbackRecommendations.menstruation;

    return `
üß† –£–ú–°–¢–í–ï–ù–ù–ê–Ø –ù–ê–ì–†–£–ó–ö–ê:
${recommendations.mental}

üèÉ‚Äç‚ôÄÔ∏è –°–ü–û–†–¢ –ò –ê–ö–¢–ò–í–ù–û–°–¢–¨:
${recommendations.sport}

ü•ó –ü–ò–¢–ê–ù–ò–ï:
${recommendations.nutrition}
`;
  }

  async generateCustomRecommendation(cycleDay, phase, specificRequest) {
    try {
      const prompt = `
–°–µ–≥–æ–¥–Ω—è ${cycleDay} –¥–µ–Ω—å –º–µ–Ω—Å—Ç—Ä—É–∞–ª—å–Ω–æ–≥–æ —Ü–∏–∫–ª–∞, —Ñ–∞–∑–∞: ${phase.name}.
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–æ–≤–µ—Ç –ø–æ —Ç–µ–º–µ: "${specificRequest}"

–î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç, —É—á–∏—Ç—ã–≤–∞—è —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É —Ü–∏–∫–ª–∞ –∏ –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω.
`;

      const response = await this.openai.chat.completions.create({
        model: "gpt-4o",
        messages: [
          {
            role: "system",
            content: "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∂–µ–Ω—Å–∫–æ–º—É –∑–¥–æ—Ä–æ–≤—å—é. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        max_tokens: 300,
        temperature: 0.7,
      });

      return response.choices[0].message.content;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:', error);
      return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    }
  }
}
